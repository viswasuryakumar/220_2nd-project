================================================================================
                        SimpleCPU16 Architecture Schematic
================================================================================

                                CPU OVERVIEW

┌──────────────────────────────────────────────────────────────────────────┐
│                                                                          │
│                            SimpleCPU16 System                            │
│                                                                          │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │                         Control Unit                           │    │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐      │    │
│  │  │   PC     │  │   IR     │  │  Decoder │  │  Control │      │    │
│  │  │ (16-bit) │  │ (16-bit) │  │  Logic   │  │  Signals │      │    │
│  │  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘      │    │
│  │       │             │             │             │              │    │
│  │       └─────────────┴─────────────┴─────────────┘              │    │
│  └──────────────────────────┬───────────────────────────────────────┐  │
│                             │                                       │  │
│         ┌───────────────────┼───────────────────┐                  │  │
│         │                   │                   │                  │  │
│         ▼                   ▼                   ▼                  │  │
│  ┌──────────────┐    ┌─────────────┐    ┌─────────────┐          │  │
│  │   Register   │    │     ALU     │    │   Memory    │          │  │
│  │     File     │◄───┤  Arithmetic │    │   System    │          │  │
│  │   (R0-R7)    │───►│   Logic     │    │   (64K)     │          │  │
│  │              │    │    Unit     │    │             │          │  │
│  │  ┌────────┐  │    │             │    │  ┌───────┐  │          │  │
│  │  │ FLAGS  │  │    │  ┌───────┐  │    │  │ MMIO  │  │          │  │
│  │  │ Z N C V│  │◄───┤  │Result │  │    │  │ I/O   │  │          │  │
│  │  └────────┘  │    │  └───┬───┘  │    │  └───────┘  │          │  │
│  └──────────────┘    └──────┼──────┘    └─────────────┘          │  │
│         ▲                   │                   ▲                  │  │
│         └───────────────────┴───────────────────┘                  │  │
│                             │                                      │  │
│                             ▼                                      │  │
│                    ┌─────────────────┐                            │  │
│                    │   Data Bus      │◄───────────────────────────┘  │
│                    │   (16-bit)      │                               │
│                    └─────────────────┘                               │
│                             ▲                                         │
│                             │                                         │
│                    ┌─────────────────┐                               │
│                    │  Address Bus    │                               │
│                    │   (16-bit)      │                               │
│                    └─────────────────┘                               │
│                                                                       │
└───────────────────────────────────────────────────────────────────────┘


================================================================================
                            DETAILED COMPONENT VIEW
================================================================================


┌─────────────────────────────────────────────────────────────────────────┐
│                           CONTROL UNIT                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌─────────────┐         ┌─────────────┐         ┌─────────────┐     │
│   │     PC      │         │     IR      │         │   Decoder   │     │
│   │  (16-bit)   │         │  (16-bit)   │         │             │     │
│   │             │         │             │         │  Opcode     │     │
│   │  Next Addr  │◄────────┤ Instruction │────────►│  [15:12]    │     │
│   │  Generator  │         │   Holder    │         │             │     │
│   │             │         │             │         │  Rd [11:9]  │     │
│   └──────┬──────┘         └─────────────┘         │  Rs [8:6]   │     │
│          │                                         │  Mode [5:0] │     │
│          │                                         └──────┬──────┘     │
│          │                                                │            │
│          │                                                ▼            │
│          │                                         ┌─────────────┐     │
│          │                                         │   Control   │     │
│          │                                         │   Logic     │     │
│          │                                         │             │     │
│          │                                         │ • RegWrite  │     │
│          │                                         │ • MemRead   │     │
│          │                                         │ • MemWrite  │     │
│          └────────────────────────────────────────►│ • ALU_Op    │     │
│                                                    │ • Branch    │     │
│                                                    │ • Jump      │     │
│                                                    └─────────────┘     │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────┐
│                          REGISTER FILE                                  │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│    ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐        │
│    │  R0  │  │  R1  │  │  R2  │  │  R3  │  │  R4  │  │  R5  │        │
│    │16-bit│  │16-bit│  │16-bit│  │16-bit│  │16-bit│  │16-bit│        │
│    └──┬───┘  └──┬───┘  └──┬───┘  └──┬───┘  └──┬───┘  └──┬───┘        │
│       │         │         │         │         │         │             │
│       └─────────┴─────────┴─────────┴─────────┴─────────┘             │
│                           │                                            │
│    ┌──────┐  ┌──────┐    │    ┌─────────────────┐                    │
│    │  R6  │  │  R7  │    │    │  Read Port A    │                    │
│    │16-bit│  │ (SP) │    └───►│  Read Port B    │────► To ALU        │
│    └──┬───┘  └──┬───┘         │  Write Port     │◄──── From ALU      │
│       │         │              └─────────────────┘                    │
│       └─────────┘                                                     │
│           │                                                           │
│           └──────────► Special Registers                             │
│                                                                       │
│                        ┌──────────────────┐                          │
│                        │   FLAGS (4-bit)  │                          │
│                        │                  │                          │
│                        │  ┌──┬──┬──┬──┐  │                          │
│                        │  │V │C │N │Z │  │                          │
│                        │  └──┴──┴──┴──┘  │                          │
│                        │   3  2  1  0     │                          │
│                        └──────────────────┘                          │
│                                                                       │
└───────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────┐
│                   ARITHMETIC LOGIC UNIT (ALU)                           │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│           Input A (16-bit)              Input B (16-bit)               │
│                 │                             │                        │
│                 ▼                             ▼                        │
│            ┌────────────────────────────────────┐                      │
│            │         Operation Select           │                      │
│            │  ┌──────────────────────────────┐  │                      │
│            │  │  Arithmetic Operations:      │  │                      │
│            │  │  • ADD  (A + B)              │  │                      │
│            │  │  • SUB  (A - B)              │  │                      │
│            │  │  • MUL  (A × B)              │  │                      │
│            │  │  • DIV  (A ÷ B)              │  │                      │
│            │  │  • INC  (A + 1)              │  │                      │
│            │  │  • DEC  (A - 1)              │  │                      │
│            │  └──────────────────────────────┘  │                      │
│            │  ┌──────────────────────────────┐  │                      │
│            │  │  Logical Operations:         │  │                      │
│            │  │  • AND  (A & B)              │  │                      │
│            │  │  • OR   (A | B)              │  │                      │
│            │  │  • XOR  (A ^ B)              │  │                      │
│            │  │  • NOT  (~A)                 │  │                      │
│            │  └──────────────────────────────┘  │                      │
│            │  ┌──────────────────────────────┐  │                      │
│            │  │  Shift Operations:           │  │                      │
│            │  │  • SHL  (A << B)             │  │                      │
│            │  │  • SHR  (A >> B)             │  │                      │
│            │  │  • SAR  (A >>> B)            │  │                      │
│            │  └──────────────────────────────┘  │                      │
│            └────────────┬───────────────────────┘                      │
│                         │                                              │
│                         ▼                                              │
│                  ┌─────────────┐                                       │
│                  │   Result    │                                       │
│                  │  (16-bit)   │                                       │
│                  └──────┬──────┘                                       │
│                         │                                              │
│          ┌──────────────┼──────────────┐                              │
│          │              │              │                              │
│          ▼              ▼              ▼                              │
│    ┌─────────┐   ┌─────────┐   ┌─────────┐                          │
│    │ Zero    │   │Negative │   │ Carry   │                          │
│    │Detector │   │Detector │   │Detector │                          │
│    │  (Z)    │   │  (N)    │   │  (C)    │                          │
│    └─────────┘   └─────────┘   └─────────┘                          │
│          │              │              │                              │
│          └──────────────┴──────────────┘                              │
│                         │                                              │
│                         ▼                                              │
│                  ┌─────────────┐                                       │
│                  │    FLAGS    │                                       │
│                  │   Update    │                                       │
│                  └─────────────┘                                       │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘


┌─────────────────────────────────────────────────────────────────────────┐
│                         MEMORY SYSTEM                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   Address Bus (16-bit) ──┐                                             │
│                          ▼                                              │
│                  ┌───────────────┐                                      │
│                  │    Address    │                                      │
│                  │    Decoder    │                                      │
│                  └───────┬───────┘                                      │
│                          │                                              │
│         ┌────────────────┼────────────────┐                            │
│         │                │                │                            │
│         ▼                ▼                ▼                            │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                    │
│  │   Program   │  │    Stack    │  │    MMIO     │                    │
│  │   Memory    │  │    Memory   │  │   Region    │                    │
│  │             │  │             │  │             │                    │
│  │ 0x0000 -    │  │ 0xE000 -    │  │ 0xF800 -    │                    │
│  │ 0xDFFF      │  │ 0xF7FF      │  │ 0xFFFF      │                    │
│  │             │  │             │  │             │                    │
│  │ 57,344 words│  │ 6,144 words │  │ 2,048 words │                    │
│  │             │  │             │  │             │                    │
│  │ Code + Data │  │ Grows ↓     │  │ I/O Devices │                    │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                    │
│         │                │                │                            │
│         └────────────────┴────────────────┘                            │
│                          │                                              │
│                          ▼                                              │
│                  ┌───────────────┐                                      │
│                  │   Data Bus    │                                      │
│                  │   (16-bit)    │                                      │
│                  └───────────────┘                                      │
│                                                                         │
│   ┌──────────────────────────────────────────────────────────┐         │
│   │          Memory-Mapped I/O Devices                       │         │
│   │                                                           │         │
│   │  0xF800: CHAR_OUT  ─┐                                    │         │
│   │  0xF801: INT_OUT   ─┤                                    │         │
│   │  0xF802: STR_OUT   ─┼──► Output Stream (stdout)          │         │
│   │  0xF810: TIMER     ─┼──► Cycle Counter (read-only)       │         │
│   │  0xF820: CHAR_IN   ─┴──► Input Stream (stdin)            │         │
│   │                                                           │         │
│   └──────────────────────────────────────────────────────────┘         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘


================================================================================
                        DATA FLOW: FETCH-DECODE-EXECUTE
================================================================================

1. FETCH PHASE:
   ┌──────┐
   │  PC  │────────► Memory Address
   └──┬───┘
      │
      │ increment
      ▼
   ┌──────┐         ┌────────┐
   │ PC+1 │◄────────│ Memory │────► Instruction ────► IR
   └──────┘         └────────┘

2. DECODE PHASE:
   ┌──────────────┐
   │      IR      │
   │  [15:12]     │────► Opcode ────► Control Unit
   │  [11:9]      │────► Rd ────────► Register Select
   │  [8:6]       │────► Rs ────────► Register Select
   │  [5:0]       │────► Mode ──────► ALU Operation
   └──────────────┘

3. EXECUTE PHASE:
   ┌──────────────┐
   │  Register    │
   │  File        │────► Operand A ───┐
   │  (Rd, Rs)    │────► Operand B ───┤
   └──────────────┘                   │
                                      ▼
                              ┌─────────────┐
                              │     ALU     │
                              │  Operation  │
                              └──────┬──────┘
                                     │
                                     ▼
                              ┌─────────────┐
                              │   Result    │
                              └──────┬──────┘
                                     │
                    ┌────────────────┼────────────────┐
                    ▼                ▼                ▼
              ┌──────────┐    ┌──────────┐    ┌──────────┐
              │ Register │    │  Memory  │    │  Flags   │
              │  Write   │    │  Write   │    │  Update  │
              └──────────┘    └──────────┘    └──────────┘


================================================================================
                           INSTRUCTION EXECUTION EXAMPLES
================================================================================

Example 1: LDI R0, 100
   ┌─────────────────────────────────────────────────────────────┐
   │ Cycle 1: FETCH                                              │
   │   PC=0x0000 → Memory[0x0000] → IR=0x1200                    │
   │   PC++                                                      │
   ├─────────────────────────────────────────────────────────────┤
   │ Cycle 1: DECODE                                             │
   │   Opcode=0x1 (LOAD), Rd=R0, Mode=0x00 (IMM)                │
   ├─────────────────────────────────────────────────────────────┤
   │ Cycle 1: EXECUTE                                            │
   │   Fetch immediate: Memory[PC] → 100                        │
   │   PC++                                                      │
   │   R0 ← 100                                                  │
   └─────────────────────────────────────────────────────────────┘

Example 2: ADD R0, R1
   ┌─────────────────────────────────────────────────────────────┐
   │ Cycle 1: FETCH                                              │
   │   PC → Memory → IR                                          │
   ├─────────────────────────────────────────────────────────────┤
   │ Cycle 1: DECODE                                             │
   │   Opcode=0x4 (ARITH), Rd=R0, Rs=R1, Mode=0x00 (ADD)        │
   ├─────────────────────────────────────────────────────────────┤
   │ Cycle 1: EXECUTE                                            │
   │   Read R0 → A                                               │
   │   Read R1 → B                                               │
   │   ALU: A + B → Result                                       │
   │   Update Flags (Z, N, C)                                    │
   │   Write Result → R0                                         │
   └─────────────────────────────────────────────────────────────┘

Example 3: BEQ loop
   ┌─────────────────────────────────────────────────────────────┐
   │ Cycle 1: FETCH                                              │
   │   PC → Memory → IR                                          │
   ├─────────────────────────────────────────────────────────────┤
   │ Cycle 1: DECODE                                             │
   │   Opcode=0x7 (BRANCH), Mode=0x00 (BEQ)                     │
   ├─────────────────────────────────────────────────────────────┤
   │ Cycle 1: EXECUTE                                            │
   │   Fetch target: Memory[PC] → addr                          │
   │   Check condition: Z flag == 1?                            │
   │   if (Z): PC ← addr                                        │
   │   else: PC++ (continue)                                    │
   └─────────────────────────────────────────────────────────────┘


================================================================================
                              BUS ARCHITECTURE
================================================================================

                    ┌─────────────────────────┐
                    │     Control Unit        │
                    └────────┬────────────────┘
                             │
                    ┌────────┴────────┐
                    │  Control Bus    │
                    │  • Read Enable  │
                    │  • Write Enable │
                    │  • Clock        │
                    └────────┬────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
        ▼                    ▼                    ▼
   ┌─────────┐         ┌─────────┐         ┌─────────┐
   │ Address │         │  Data   │         │ Control │
   │   Bus   │         │   Bus   │         │  Logic  │
   │ 16-bit  │         │ 16-bit  │         │         │
   └────┬────┘         └────┬────┘         └─────────┘
        │                   │
        │                   │
   ┌────┴───────────────────┴────┐
   │                              │
   ▼                              ▼
┌─────────┐                  ┌─────────┐
│ Memory  │◄────────────────►│Register │
│ System  │     Data Flow    │  File   │
└─────────┘                  └─────────┘


================================================================================
                            STACK OPERATION
================================================================================

Stack grows DOWNWARD from 0xE000:

    Initial State:              After PUSH R0:           After POP R1:

    SP = 0xE000                 SP = 0xDFFF              SP = 0xE000
         │                           │                        │
         ▼                           ▼                        ▼
    ┌─────────┐                ┌─────────┐              ┌─────────┐
    │  0xE000 │ ← SP           │  0xE000 │              │  0xE000 │ ← SP
    ├─────────┤                ├─────────┤              ├─────────┤
    │  0xDFFF │                │  0xDFFF │ ← SP         │  0xDFFF │
    ├─────────┤                ├─────────┤   (R0 val)   ├─────────┤
    │  0xDFFE │                │  0xDFFE │              │  0xDFFE │
    └─────────┘                └─────────┘              └─────────┘


================================================================================
                       FUNCTION CALL MECHANISM
================================================================================

CALL sequence:
    1. SP ← SP - 1           (Decrement stack pointer)
    2. Memory[SP] ← PC       (Save return address)
    3. PC ← function_addr    (Jump to function)

         Before CALL:              After CALL:

         PC = 0x0100               PC = 0x0500 (function)
         SP = 0xE000               SP = 0xDFFF
              │                         │
              ▼                         ▼
         ┌─────────┐              ┌─────────┐
         │  0xE000 │ ← SP         │  0xE000 │
         ├─────────┤              ├─────────┤
         │  0xDFFF │              │  0xDFFF │ ← SP (0x0100)
         └─────────┘              └─────────┘

RET sequence:
    1. PC ← Memory[SP]       (Restore return address)
    2. SP ← SP + 1           (Increment stack pointer)


================================================================================
                          END OF SCHEMATIC
================================================================================
